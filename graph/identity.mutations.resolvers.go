package graph

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.49

import (
	"context"
	"fmt"
	"imgdd/graph/model"
	"imgdd/identity"
)

// Authenticate is the resolver for the authenticate field.
func (r *mutationResolver) Authenticate(ctx context.Context, email string, password string, organizationID *string) (*model.ViewerResult, error) {
	user := r.IdentityRepo.GetUserByEmail(email)
	if user == nil {
		return nil, fmt.Errorf("user not found")
	}
	if !identity.CheckPasswordByUserId(user.Id, password, r.IdentityRepo) {
		return nil, fmt.Errorf("password incorrect")
	}
	_, orgUser := r.IdentityRepo.GetOrganizationForUser(user.Id, *organizationID)
	if orgUser == nil {
		return nil, fmt.Errorf("organization not found")
	}
	r.LoginFn(ctx, user.Id, orgUser.Id)
	return &model.ViewerResult{Viewer: &model.Viewer{}}, nil
}

// Logout is the resolver for the logout field.
func (r *mutationResolver) Logout(ctx context.Context) (*model.ViewerResult, error) {
	r.LogoutFn(ctx)
	return &model.ViewerResult{Viewer: &model.Viewer{}}, nil
}

// CreateUserWithOrganization is the resolver for the createUserWithOrganization field.
func (r *mutationResolver) CreateUserWithOrganization(ctx context.Context, input model.CreateUserWithOrganizationInput) (*model.ViewerResult, error) {
	orgName := input.OrganizationName
	if orgName == "" {
		orgName = input.UserEmail + "'s organization"
	}
	orgUser, err := r.IdentityRepo.CreateUserWithOrganization(
		input.UserEmail,
		orgName,
		input.UserPassword,
	)
	if err != nil {
		return nil, err
	}
	r.LoginFn(ctx, orgUser.User.Id, orgUser.Id)
	return &model.ViewerResult{Viewer: &model.Viewer{}}, nil
}

// Mutation returns MutationResolver implementation.
func (r *Resolver) Mutation() MutationResolver { return &mutationResolver{r} }

type mutationResolver struct{ *Resolver }
